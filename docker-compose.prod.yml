version: '3.8'
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: web360_backend_prod
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    volumes:
      # Production: chỉ mount data, không mount code
      - ./backend/uploads:/app/uploads
      - ./cms/data:/app/cms/data:rw
      - ./backend/keys/google-tts-key.json:/app/backend/keys/google-tts-key.json:ro
      - ./backend/static/tts:/app/static/tts
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/backend/keys/google-tts-key.json
      - FLASK_ENV=production
      - FLASK_DEBUG=0
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-1}
      - TZ=Asia/Ho_Chi_Minh
      - AUTH_SECRET_KEY=${AUTH_SECRET_KEY:-change_me_in_production}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    networks:
      - web360_net

  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    container_name: web360_nginx_prod
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend/static/tts:/usr/share/nginx/html/static/tts:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - web360_net

networks:
  web360_net:
    driver: bridge

