version: '3.8'
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: web360_backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    volumes:
      # 1. Mount toàn bộ code vào /app (File key sẽ nằm ở /app/keys/google-tts-key.json)
      - ./backend:/app
      
      # 2. Mount thư mục uploads và cms data (giữ nguyên)
      - ./backend/uploads:/app/uploads
      - ./cms/data:/app/cms/data:rw
      
      # 3. XÓA DÒNG MOUNT FILE KEY RIÊNG LẺ ĐỂ TRÁNH LỖI CACHE CŨ
      # Docker sẽ tự đọc key từ volume dòng số 1
      
      - ./backend/static/tts:/app/static/tts
      
    environment:
      # SỬA ĐƯỜNG DẪN NÀY CHO KHỚP VỚI CẤU TRÚC CONTAINER (/app/keys/...)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/keys/google-tts-key.json
      - FLASK_ENV=production
      - FLASK_DEBUG=0
      - GUNICORN_WORKERS=4
      - GUNICORN_THREADS=1
      - TZ=Asia/Ho_Chi_Minh
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    networks:
      - web360_net

  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    container_name: web360_nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend/static/tts:/usr/share/nginx/html/static/tts:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - web360_net

networks:
  web360_net:
    driver: bridge